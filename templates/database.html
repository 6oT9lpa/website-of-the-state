<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animation-bg.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index-style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/database-style.css') }}">
    <title>Majestic State</title>

    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='img/android-chrome-512x512.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='img/android-chrome-192x192.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='img/site.webmanifest') }}">
</head>
<body>
    {% block header %}
        {% include 'header/header-account.html' %}
    {% endblock %}

    {% block error %}
        {% include 'api/error-json.html' %}
    {% endblock %}

    {% block main %}
        {% include 'main/main-database.html' %}
    {% endblock %}
    <div id="loader" class="loader"></div>

    <div class="lines">
        {% for i in range(40) %}
        <div class="line"></div>
        {% endfor %}
    </div>

    <div class="overlay" id='overlay'></div>
<script>
    document.querySelectorAll('.rank-list').forEach(rankList => {
        new Sortable(rankList, {
            animation: 150,
            onStart(evt) {
                const leaderItem = evt.from.querySelector('[data-leader="true"]');
                if (leaderItem && evt.item === leaderItem) {
                    evt.item.setAttribute('draggable', 'false');
                }
            },
            onEnd(evt) {
                evt.from.querySelectorAll('.rank-item').forEach(item => {
                    item.setAttribute('draggable', 'true');
                });
    
                updateRankIds(evt.from);
            }
        });
    });
    
        function updateRankIds(list) {
        let index = list.querySelectorAll('.rank-item').length; 
        list.querySelectorAll('.rank-item').forEach(item => {
            const newId = index--; 
            const rankIdInput = item.querySelector('.rank-id');
    
            if (rankIdInput) {
                rankIdInput.value = newId;
            }
    
            if (item.getAttribute('data-recon') === 'true') {
                item.setAttribute('data-id', newId);
    
                if (rankIdInput) {
                    rankIdInput.value = newId;
                }
            }
        });
    }
    
    
        function filterRanksByFraction(fraction) {
            document.querySelectorAll('.fraction-group').forEach(group => {
                if (!fraction || group.dataset.fraction === fraction) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
        }
    
        let ranksToAdd = [];
    
        function addRank(fraction) {
        const rankList = document.getElementById(`${fraction}-list`);
        const newId = generateNewId(rankList);
    
        const newItem = document.createElement('li');
        newItem.className = 'rank-item';
        newItem.setAttribute('data-id', newId);
        newItem.setAttribute('data-leader', 'false');
        newItem.setAttribute('data-recon', 'true');
        newItem.innerHTML = `
            <input type="text" class="rank-id" value="${newId}" readonly>
            <input type="text" class="rank-name" value="Новый ранг">
            <button class="delete-rank" onclick="deleteRank('${fraction}', ${newId})">Удалить</button>
        `;
    
        rankList.appendChild(newItem);
    
    
        console.log('Новый ранг добавлен:', ranksToAdd);
    
        updateRankIds(rankList);
    }
    
        function generateNewId(rankList) {
            let maxId = 0;
            rankList.querySelectorAll('.rank-item').forEach(item => {
                const id = parseInt(item.querySelector('.rank-id').value, 10);
                if (id > maxId) maxId = id;
            });
            return maxId + 1;
        }

        let ranksToDelete = [];

        function deleteRank(fraction, id) {
        const rankItem = document.querySelector(`[data-fraction="${fraction}"] [data-id="${id}"]`);
        if (rankItem) {
            if (rankItem.getAttribute('data-recon') === 'true') {
    
            } else {
                ranksToDelete.push({
                    organ: fraction,
                    id: id
                });
            }
    
            rankItem.remove();
            updateRankIds(document.getElementById(`${fraction}-list`));
        }
    }

    function saveRanks() {
        const updatedRanks = {};

        document.querySelectorAll('.fraction-group').forEach(group => {
            const fraction = group.dataset.fraction;
            const ranks = [];
            group.querySelectorAll('.rank-item').forEach(item => {
                const leaderSpan = item.querySelector('.leader-label');
                const isLeader = leaderSpan !== null;
    
                ranks.push({
                    id: parseInt(item.querySelector('.rank-id').value),
                    name: item.querySelector('.rank-name').value,
                    leader: isLeader
                });
            });
            updatedRanks[fraction] = ranks;
        });
    
        const reconElements = document.querySelectorAll('[data-recon="true"]');
        reconElements.forEach(element => {
            rankidadd = element.querySelector('.rank-id').value;
            ranknameadd = element.querySelector('.rank-name').value;
            element.setAttribute('data-recon', 'false');
    
            const deleteButton = element.querySelector('.delete-rank'); 
            const onclickAttr = deleteButton.getAttribute('onclick'); 
            const fractionMatch = onclickAttr.match(/deleteRank\('([^']+)'/); 
            const fraction = fractionMatch ? fractionMatch[1] : null;
    
            ranksToAdd.push({
            organ: fraction,
            id: rankidadd,
            name: ranknameadd,
            leader: false
        });
        });

        const dataToSend = {
            updated_ranks: updatedRanks,
            ranks_to_delete: ranksToDelete,
            ranks_to_add: ranksToAdd
        };
    
        console.log('Saving ranks:', dataToSend);

        ranksToDelete = [];
        ranksToAdd = [];
    
        fetch('/save_ranks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSend)
        }).then(response => {
            if (response.ok) {
                alert('Изменения сохранены!');
            } else {
                alert('Ошибка при сохранении.');
            }
        });
    }
        
        document.querySelectorAll('.rank-list').forEach(rankList => {
            new Sortable(rankList, {
                animation: 150,
                onEnd: function (evt) {
                    console.log('Rank reordered:', evt);
                }
            });
        });

        document.querySelectorAll('.user-row').forEach(row => {
            row.addEventListener('dblclick', function() {
                const userId = this.getAttribute('data-user-id');
                
                window.location.href = `/database_getdata?user_id=${userId}`;
            });
        });
        

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
        }
        function filterRanksByFraction(fraction) {
            document.querySelectorAll('.fraction-group').forEach(group => {
                if (!fraction || group.dataset.fraction === fraction) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            showTab('users');
            filterRanksByFraction('LSPD');
        });

        if (document.getElementById('toggleKaHistoryBtn')) {
            document.getElementById('toggleKaHistoryBtn').addEventListener('click', function() {
                var kaHistory = document.getElementById('kaHistory');
                var button = document.getElementById('toggleKaHistoryBtn');
                
                if (kaHistory.style.display === 'none') {
                    kaHistory.style.display = 'flex';
                    document.querySelectorAll('#overlay').forEach(o => {
                        o.classList.add('active');
                    });
                
                    setTimeout(() => {
                        kaHistory.classList.remove('hidden-modal');
                        kaHistory.classList.add('show-modal');
                    }, 10);

                    button.textContent = 'Скрыть Историю КА'; 
                } else {
                    kaHistory.classList.remove('show-modal');
                    kaHistory.classList.add('hidden-modal');

                    setTimeout(() => {
                        kaHistory.style.display = 'none';
                        document.querySelectorAll('#overlay').forEach(o => {
                            o.classList.remove('active');
                        });
                    }, 450);
                    button.textContent = 'Показать Историю КА';
                }
            });
        }
        let debounceTimer;

        document.getElementById('searchInput').addEventListener('input', debounce(performSearch, 500));
        document.getElementById('filter').addEventListener('change', performSearch);

        function debounce(callback, delay) {
            return function (...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => callback(...args), delay);
            };
        }

        function performSearch() {
            const searchInput = document.getElementById('searchInput').value.trim();
            const filterValue = document.getElementById('filter').value;

            if (!searchInput && !filterValue) {
                updateTable([]);
                return;
            }

            setLoading(true);

            fetch(`/getSearchUser?inputVal=${encodeURIComponent(searchInput)}&filterVal=${encodeURIComponent(filterValue)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка при запросе на сервер');
                    }
                    return response.json();
                })
                .then(data => {
                    setLoading(false);
                    if (data.success) {
                        updateTable(data.results);
                    } else {
                        updateTable([]);
                        console.error('Нет данных для отображения');
                    }
                })
                .catch(error => {
                    setLoading(false); 
                    console.error('Ошибка при запросе:', error);
                });
        }

        function updateTable(users) {
            const tableBody = document.querySelector('table tbody');
            if (!tableBody) {
                console.error('Таблица не найдена в DOM.');
                return;
            }

            tableBody.innerHTML = '';

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr class="empty-message">
                        <td colspan="5">Данные не найдены</td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.classList.add('user-row');
                row.dataset.userId = user.id;

                row.innerHTML = `
                    <td>${user.nikname}</td>
                    <td>${user.static}</td>
                    <td>${user.organ}</td>
                    <td>${user.curr_rank}</td>
                    <td>${user.discordname}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        function setLoading(isLoading) {
            if (isLoading) {
                document.body.classList.add('loading');
            } else {
                document.body.classList.remove('loading');
            }
        }

        function checkPermissions(tabName) {
            fetch('/check_permissions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTab(tabName); 
                } else {
                    showNotification(data.message, true); 
                }
            })
            .catch(error => console.error('Ошибка при проверке прав:', error));
        }
        
    </script>
</body>
</html>


